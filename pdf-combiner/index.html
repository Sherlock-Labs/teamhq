<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Combiner â€” Sherlock Labs</title>
  <meta name="description" content="Combine multiple images and PDFs into a single document. Drag to reorder, then download. Free, private, runs entirely in your browser.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Design tokens are intentionally self-contained in this file.
       See docs/design-token-consolidation-tech-approach.md, Decision 2. */
    /* --- Design Tokens --- */
    :root {
      --zinc-100: #f4f4f5;
      --zinc-200: #e4e4e7;
      --zinc-300: #d4d4d8;
      --zinc-400: #a1a1aa;
      --zinc-500: #71717a;
      --zinc-600: #52525b;
      --zinc-700: #3f3f46;
      --zinc-800: #27272a;
      --zinc-900: #18181b;
      --zinc-950: #09090b;
      --indigo-400: #818cf8;
      --indigo-500: #6366f1;
      --indigo-600: #4f46e5;
      --red-400: #f87171;
      --font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    }

    /* --- Reset --- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background: var(--zinc-950);
      color: var(--zinc-300);
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a:focus-visible,
    button:focus-visible {
      outline: 2px solid var(--indigo-500);
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* --- Container --- */
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding-left: 20px;
      padding-right: 20px;
    }

    @media (min-width: 640px) {
      .container {
        padding-left: 32px;
        padding-right: 32px;
      }
    }

    /* --- Nav (matches TeamHQ pattern) --- */
    .nav {
      background: var(--zinc-950);
      border-bottom: 1px solid var(--zinc-800);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
    }

    .nav__brand {
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    .nav__logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
    }

    .nav__logo {
      height: 36px;
      width: auto;
      display: block;
    }

    @media (max-width: 639px) {
      .nav__logo {
        height: 28px;
      }
    }

    .nav__back {
      font-size: 14px;
      font-weight: 500;
      color: var(--zinc-400);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color 0.15s ease;
    }

    .nav__back:hover {
      color: var(--zinc-200);
    }

    .nav__back-arrow {
      font-size: 16px;
    }

    /* --- Main --- */
    .main {
      flex: 1;
      padding: 32px 0;
    }

    /* --- Upload Zone --- */
    .upload-zone {
      border: 2px dashed var(--zinc-700);
      border-radius: 12px;
      padding: 64px 32px;
      background: var(--zinc-900);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .upload-zone:focus-visible {
      outline: 2px solid var(--indigo-500);
      outline-offset: 2px;
      border-radius: 12px;
    }

    .upload-zone--dragover {
      border-color: var(--indigo-500);
      background: rgba(99, 102, 241, 0.05);
    }

    .upload-zone--dragover .upload-zone__icon {
      stroke: var(--indigo-500);
    }

    .upload-zone__icon {
      width: 48px;
      height: 48px;
      stroke: var(--zinc-600);
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.15s ease;
    }

    .upload-zone__text {
      font-size: 18px;
      font-weight: 600;
      color: var(--zinc-300);
      margin-top: 16px;
    }

    .upload-zone__or {
      font-size: 14px;
      color: var(--zinc-600);
      margin: 8px 0;
    }

    .upload-zone__btn {
      background: var(--indigo-500);
      color: #fff;
      font-family: var(--font-family);
      font-size: 14px;
      font-weight: 600;
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .upload-zone__btn:hover {
      background: var(--indigo-400);
    }

    .upload-zone__hint {
      font-size: 12px;
      color: var(--zinc-600);
      margin-top: 16px;
    }

    /* --- Toolbar --- */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--zinc-900);
      border: 1px solid var(--zinc-800);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .toolbar--dragover {
      border-color: var(--indigo-500);
      background: rgba(99, 102, 241, 0.05);
    }

    .toolbar__add {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--zinc-400);
      background: none;
      border: none;
      cursor: pointer;
      font-family: var(--font-family);
      transition: color 0.15s ease;
    }

    .toolbar__add:hover {
      color: var(--zinc-300);
    }

    .toolbar__add-icon {
      font-size: 18px;
      font-weight: 600;
      line-height: 1;
    }

    .toolbar__clear {
      font-size: 14px;
      font-weight: 500;
      color: var(--zinc-500);
      background: none;
      border: none;
      cursor: pointer;
      font-family: var(--font-family);
      transition: color 0.15s ease;
    }

    .toolbar__clear:hover {
      color: var(--red-400);
    }

    /* --- Page Count Summary --- */
    .page-summary {
      font-size: 14px;
      color: var(--zinc-400);
      padding: 8px 0;
      margin-bottom: 4px;
    }

    /* --- File List --- */
    .file-list {
      list-style: none;
      margin-bottom: 16px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--zinc-900);
      border: 1px solid var(--zinc-800);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: border-color 0.15s ease;
    }

    .file-item:hover {
      border-color: var(--zinc-700);
    }

    .file-item--error {
      border-color: rgba(248, 113, 113, 0.2);
      background: rgba(248, 113, 113, 0.03);
    }

    /* SortableJS states */
    .file-item--ghost {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .file-item--chosen {
      border-color: var(--indigo-500);
      background: rgba(99, 102, 241, 0.05);
    }

    /* Drag handle */
    .file-item__handle {
      cursor: grab;
      color: var(--zinc-600);
      width: 16px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s ease;
    }

    .file-item__handle:active {
      cursor: grabbing;
    }

    .file-item__handle:hover {
      color: var(--zinc-400);
    }

    .file-item__handle svg {
      width: 16px;
      height: 16px;
    }

    /* Thumbnail */
    .file-item__thumb {
      width: 48px;
      height: 48px;
      border-radius: 4px;
      overflow: hidden;
      background: var(--zinc-800);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .file-item__thumb canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .file-item__thumb--loading {
      animation: thumb-pulse 1.5s ease-in-out infinite;
    }

    @keyframes thumb-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .file-item__thumb-error {
      color: var(--red-400);
      font-size: 18px;
    }

    /* File info */
    .file-item__info {
      flex: 1;
      min-width: 0;
    }

    .file-item__name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }

    .file-item__name {
      font-size: 14px;
      font-weight: 500;
      color: var(--zinc-200);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-item__badge {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 2px 6px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .file-item__badge--pdf {
      color: var(--indigo-400);
      background: rgba(99, 102, 241, 0.1);
    }

    .file-item__badge--image {
      color: var(--zinc-400);
      background: rgba(161, 161, 170, 0.1);
    }

    .file-item__meta {
      font-size: 12px;
      color: var(--zinc-500);
    }

    .file-item__error-msg {
      font-size: 12px;
      color: var(--red-400);
    }

    /* Remove button */
    .file-item__remove {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--zinc-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .file-item__remove:hover {
      background: rgba(248, 113, 113, 0.1);
      color: var(--red-400);
    }

    .file-item__remove svg {
      width: 14px;
      height: 14px;
    }

    /* --- Combine Button --- */
    .combine-btn {
      width: 100%;
      padding: 12px 24px;
      border-radius: 8px;
      background: var(--indigo-500);
      color: #fff;
      font-family: var(--font-family);
      font-size: 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .combine-btn:hover {
      background: var(--indigo-400);
    }

    .combine-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .combine-btn:disabled:hover {
      background: var(--indigo-500);
    }

    .combine-btn--success {
      background: #059669;
    }

    .combine-btn--success:hover {
      background: #059669;
    }

    /* Spinner */
    .combine-btn__spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--zinc-700);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* --- Combining state overlay on file list --- */
    .file-list--combining {
      opacity: 0.7;
      pointer-events: none;
    }

    .file-list--combining .file-item__handle,
    .file-list--combining .file-item__remove {
      visibility: hidden;
    }

    /* --- Toast --- */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      z-index: 300;
      background: var(--zinc-800);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 8px;
      padding: 12px 20px;
      opacity: 0;
      transition: transform 0.25s ease, opacity 0.25s ease;
      pointer-events: none;
      max-width: 90vw;
    }

    .toast--visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .toast__text {
      font-size: 14px;
      color: var(--red-400);
      white-space: nowrap;
    }

    @media (max-width: 639px) {
      .toast__text {
        white-space: normal;
      }
    }

    /* --- Footer --- */
    .footer {
      background: var(--zinc-900);
      border-top: 1px solid var(--zinc-800);
      padding: 32px 0;
      text-align: center;
    }

    .footer__logo {
      height: 28px;
      width: auto;
      display: block;
      margin: 0 auto 12px;
    }

    .footer__attribution {
      font-size: 14px;
      color: var(--zinc-600);
    }

    /* --- Responsive --- */
    @media (max-width: 639px) {
      .upload-zone {
        padding: 48px 24px;
      }

      .toolbar {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }

      .toolbar__add {
        justify-content: center;
      }

      .toolbar__clear {
        text-align: center;
      }

      .file-item__thumb {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="nav">
    <div class="container nav__inner">
      <div class="nav__brand">
        <a href="../index.html" class="nav__logo-link">
          <img src="../img/sherlock-labs-logo.svg" alt="Sherlock Labs" class="nav__logo" width="180" height="36">
        </a>
      </div>
      <a href="../index.html" class="nav__back">
        <span class="nav__back-arrow" aria-hidden="true">&larr;</span>
        TeamHQ
      </a>
    </div>
  </nav>

  <main class="main">
    <div class="container" id="app">

      <!-- Upload Zone -->
      <div class="upload-zone" id="upload-zone" role="button" tabindex="0" aria-label="Upload images or PDFs">
        <svg class="upload-zone__icon" viewBox="0 0 48 48" aria-hidden="true">
          <rect x="14" y="4" width="24" height="32" rx="3" ry="3"/>
          <rect x="10" y="8" width="24" height="32" rx="3" ry="3"/>
          <line x1="22" y1="30" x2="22" y2="18"/>
          <polyline points="16 24 22 18 28 24"/>
        </svg>
        <p class="upload-zone__text">Drop images or PDFs here</p>
        <p class="upload-zone__or">or</p>
        <button class="upload-zone__btn" type="button" id="browse-btn">Browse Files</button>
        <p class="upload-zone__hint">Supports PDF, PNG, JPG, WebP, GIF, BMP, TIFF</p>
        <input type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.gif,.bmp,.tiff,application/pdf,image/png,image/jpeg,image/webp,image/gif,image/bmp,image/tiff" id="file-input" multiple hidden>
      </div>

      <!-- Loaded State (hidden initially) -->
      <div id="loaded-state" hidden>
        <!-- Toolbar -->
        <div class="toolbar" id="toolbar">
          <button class="toolbar__add" type="button" id="add-more-btn">
            <span class="toolbar__add-icon" aria-hidden="true">+</span>
            Add more files
          </button>
          <button class="toolbar__clear" type="button" id="clear-all-btn">Clear All</button>
          <input type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.gif,.bmp,.tiff,application/pdf,image/png,image/jpeg,image/webp,image/gif,image/bmp,image/tiff" id="add-file-input" multiple hidden>
        </div>

        <!-- Page count summary -->
        <p class="page-summary" id="page-summary"></p>

        <!-- File list -->
        <ul class="file-list" id="file-list" role="list"></ul>

        <!-- Combine button -->
        <button class="combine-btn" id="combine-btn" type="button" disabled>
          Combine &amp; Download
        </button>
      </div>

    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast" role="alert">
    <span class="toast__text" id="toast-text"></span>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <img src="../img/sherlock-labs-logo.svg" alt="Sherlock Labs" class="footer__logo" width="140" height="28">
      <p class="footer__attribution">Built with Claude Code</p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.6/Sortable.min.js"></script>
  <script>
    (function () {
      'use strict';

      // Configure pdf.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      // --- Supported types ---
      var SUPPORTED_TYPES = {
        'application/pdf': 'pdf',
        'image/png': 'image',
        'image/jpeg': 'image',
        'image/webp': 'image',
        'image/gif': 'image',
        'image/bmp': 'image',
        'image/tiff': 'image'
      };

      var EXTENSION_MAP = {
        'pdf': 'pdf',
        'png': 'image',
        'jpg': 'image',
        'jpeg': 'image',
        'webp': 'image',
        'gif': 'image',
        'bmp': 'image',
        'tiff': 'image',
        'tif': 'image'
      };

      // Native pdf-lib image formats
      var NATIVE_IMAGE_TYPES = ['image/png', 'image/jpeg'];

      // --- DOM refs ---
      var uploadZone = document.getElementById('upload-zone');
      var browseBtn = document.getElementById('browse-btn');
      var fileInput = document.getElementById('file-input');
      var loadedState = document.getElementById('loaded-state');
      var toolbar = document.getElementById('toolbar');
      var addMoreBtn = document.getElementById('add-more-btn');
      var addFileInput = document.getElementById('add-file-input');
      var clearAllBtn = document.getElementById('clear-all-btn');
      var pageSummary = document.getElementById('page-summary');
      var fileListEl = document.getElementById('file-list');
      var combineBtn = document.getElementById('combine-btn');
      var toastEl = document.getElementById('toast');
      var toastText = document.getElementById('toast-text');

      // --- State ---
      var files = [];
      var isCombining = false;
      var toastTimer = null;
      var sortable = null;

      // --- UUID helper (fallback for non-HTTPS) ---
      function generateId() {
        if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
          try { return crypto.randomUUID(); } catch (e) { /* fall through */ }
        }
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
      }

      // --- Upload Zone Events ---

      uploadZone.addEventListener('click', function (e) {
        if (e.target === browseBtn || browseBtn.contains(e.target)) return;
        fileInput.click();
      });

      uploadZone.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fileInput.click();
        }
      });

      browseBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        fileInput.click();
      });

      fileInput.addEventListener('change', function () {
        if (fileInput.files.length > 0) {
          handleFiles(fileInput.files);
          fileInput.value = '';
        }
      });

      // Drag and drop on upload zone
      uploadZone.addEventListener('dragenter', function (e) {
        e.preventDefault();
        uploadZone.classList.add('upload-zone--dragover');
      });

      uploadZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadZone.classList.add('upload-zone--dragover');
      });

      uploadZone.addEventListener('dragleave', function (e) {
        e.preventDefault();
        uploadZone.classList.remove('upload-zone--dragover');
      });

      uploadZone.addEventListener('drop', function (e) {
        e.preventDefault();
        uploadZone.classList.remove('upload-zone--dragover');
        if (e.dataTransfer.files.length > 0) {
          handleFiles(e.dataTransfer.files);
        }
      });

      // --- Toolbar Events ---

      addMoreBtn.addEventListener('click', function () {
        addFileInput.click();
      });

      addFileInput.addEventListener('change', function () {
        if (addFileInput.files.length > 0) {
          handleFiles(addFileInput.files);
          addFileInput.value = '';
        }
      });

      clearAllBtn.addEventListener('click', function () {
        files = [];
        renderAll();
      });

      // Drag and drop on toolbar
      toolbar.addEventListener('dragenter', function (e) {
        e.preventDefault();
        toolbar.classList.add('toolbar--dragover');
      });

      toolbar.addEventListener('dragover', function (e) {
        e.preventDefault();
        toolbar.classList.add('toolbar--dragover');
      });

      toolbar.addEventListener('dragleave', function (e) {
        e.preventDefault();
        toolbar.classList.remove('toolbar--dragover');
      });

      toolbar.addEventListener('drop', function (e) {
        e.preventDefault();
        toolbar.classList.remove('toolbar--dragover');
        if (e.dataTransfer.files.length > 0) {
          handleFiles(e.dataTransfer.files);
        }
      });

      // --- Combine Button ---

      combineBtn.addEventListener('click', function () {
        if (isCombining || files.length === 0) return;
        combineAndDownload();
      });

      // --- File Handling ---

      function getFileTypeCategory(file) {
        if (SUPPORTED_TYPES[file.type]) return SUPPORTED_TYPES[file.type];
        var ext = file.name.split('.').pop().toLowerCase();
        if (EXTENSION_MAP[ext]) return EXTENSION_MAP[ext];
        return null;
      }

      function getFileExtLabel(file) {
        var ext = file.name.split('.').pop().toUpperCase();
        if (ext === 'JPEG') ext = 'JPG';
        if (ext === 'TIF') ext = 'TIFF';
        return ext;
      }

      function handleFiles(fileList) {
        var unsupported = [];
        var toAdd = [];

        for (var i = 0; i < fileList.length; i++) {
          var file = fileList[i];
          var category = getFileTypeCategory(file);
          if (!category) {
            unsupported.push(file.name);
            continue;
          }
          toAdd.push({
            id: generateId(),
            file: file,
            type: category,
            name: file.name,
            size: file.size,
            pageCount: category === 'image' ? 1 : 0,
            thumbnailCanvas: null,
            pdfLibDoc: null,
            error: null
          });
        }

        if (unsupported.length > 0) {
          if (unsupported.length === 1) {
            showToast(unsupported[0] + ' is not a supported format');
          } else {
            showToast(unsupported.length + ' files were not a supported format');
          }
        }

        if (toAdd.length === 0) return;

        files = files.concat(toAdd);
        renderAll();

        // Process each new file async
        toAdd.forEach(function (entry) {
          processFile(entry);
        });
      }

      async function processFile(entry) {
        try {
          var arrayBuffer = await readFileAsArrayBuffer(entry.file);
          var bytes = new Uint8Array(arrayBuffer);

          if (entry.type === 'pdf') {
            await processPdf(entry, bytes);
          } else {
            await processImage(entry);
          }
        } catch (err) {
          entry.error = 'Could not read this file';
          entry.pageCount = 0;
        }

        updateFileItem(entry);
        updatePageCount();
      }

      async function processPdf(entry, bytes) {
        try {
          entry.pdfLibDoc = await PDFLib.PDFDocument.load(bytes, { ignoreEncryption: true });
          entry.pageCount = entry.pdfLibDoc.getPageCount();
          if (entry.pageCount === 0) {
            entry.error = 'This PDF has no pages';
            return;
          }
        } catch (err) {
          entry.error = 'Could not read this file';
          entry.pageCount = 0;
          return;
        }

        // Generate square thumbnail from first page via pdf.js
        try {
          var pdfJsDoc = await pdfjsLib.getDocument({ data: bytes.slice(0) }).promise;
          var page = await pdfJsDoc.getPage(1);
          var viewport = page.getViewport({ scale: 1 });
          var thumbSize = 96; // 2x for retina
          // Render at a scale that covers the square
          var coverScale = Math.max(thumbSize / viewport.width, thumbSize / viewport.height);
          var scaledViewport = page.getViewport({ scale: coverScale });

          // Render full page to a temp canvas
          var tempCanvas = document.createElement('canvas');
          tempCanvas.width = scaledViewport.width;
          tempCanvas.height = scaledViewport.height;
          var tempCtx = tempCanvas.getContext('2d');
          await page.render({ canvasContext: tempCtx, viewport: scaledViewport }).promise;

          // Center-crop into a square canvas
          var canvas = document.createElement('canvas');
          canvas.width = thumbSize;
          canvas.height = thumbSize;
          var ctx = canvas.getContext('2d');
          var cropX = Math.round((scaledViewport.width - thumbSize) / 2);
          var cropY = Math.round((scaledViewport.height - thumbSize) / 2);
          ctx.drawImage(tempCanvas, cropX, cropY, thumbSize, thumbSize, 0, 0, thumbSize, thumbSize);

          entry.thumbnailCanvas = canvas;
          pdfJsDoc.destroy();
        } catch (err) {
          // Thumbnail is nice-to-have
        }
      }

      async function processImage(entry) {
        try {
          var img = await loadImage(entry.file);
          // Generate square thumbnail using cover-crop approach
          var thumbSize = 96;
          var canvas = document.createElement('canvas');
          canvas.width = thumbSize;
          canvas.height = thumbSize;
          var ctx = canvas.getContext('2d');
          var iw = img.naturalWidth;
          var ih = img.naturalHeight;
          // Scale to cover the square, then center-crop
          var scale = Math.max(thumbSize / iw, thumbSize / ih);
          var sw = Math.round(iw * scale);
          var sh = Math.round(ih * scale);
          var sx = Math.round((thumbSize - sw) / 2);
          var sy = Math.round((thumbSize - sh) / 2);
          ctx.drawImage(img, sx, sy, sw, sh);
          entry.thumbnailCanvas = canvas;
          entry.pageCount = 1;
        } catch (err) {
          entry.error = 'Could not read this file';
          entry.pageCount = 0;
        }
      }

      function loadImage(file) {
        return new Promise(function (resolve, reject) {
          var img = new Image();
          var url = URL.createObjectURL(file);
          img.onload = function () {
            URL.revokeObjectURL(url);
            resolve(img);
          };
          img.onerror = function () {
            URL.revokeObjectURL(url);
            reject(new Error('Image load failed'));
          };
          img.src = url;
        });
      }

      function readFileAsArrayBuffer(file) {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onload = function () { resolve(reader.result); };
          reader.onerror = function () { reject(new Error('Read failed')); };
          reader.readAsArrayBuffer(file);
        });
      }

      // --- Rendering ---

      function renderAll() {
        if (files.length === 0) {
          uploadZone.hidden = false;
          loadedState.hidden = true;
          destroySortable();
          return;
        }

        uploadZone.hidden = true;
        loadedState.hidden = false;

        // Render file list
        fileListEl.innerHTML = '';
        files.forEach(function (entry) {
          fileListEl.appendChild(createFileItemEl(entry));
        });

        updatePageCount();
        initSortable();
      }

      function createFileItemEl(entry) {
        var li = document.createElement('li');
        li.className = 'file-item' + (entry.error ? ' file-item--error' : '');
        li.setAttribute('role', 'listitem');
        li.setAttribute('data-id', entry.id);

        // Drag handle
        if (!entry.error) {
          var handle = document.createElement('div');
          handle.className = 'file-item__handle';
          handle.setAttribute('aria-label', 'Reorder ' + escapeAttr(entry.name));
          handle.innerHTML = '<svg viewBox="0 0 16 20" fill="currentColor"><circle cx="5" cy="4" r="2"/><circle cx="11" cy="4" r="2"/><circle cx="5" cy="10" r="2"/><circle cx="11" cy="10" r="2"/><circle cx="5" cy="16" r="2"/><circle cx="11" cy="16" r="2"/></svg>';
          li.appendChild(handle);
        } else {
          // Spacer for error items (no handle)
          var spacer = document.createElement('div');
          spacer.style.width = '16px';
          spacer.style.flexShrink = '0';
          li.appendChild(spacer);
        }

        // Thumbnail
        var thumb = document.createElement('div');
        thumb.className = 'file-item__thumb';
        thumb.id = 'thumb-' + entry.id;
        if (entry.error) {
          thumb.innerHTML = '<span class="file-item__thumb-error" aria-hidden="true">!</span>';
        } else if (entry.thumbnailCanvas) {
          thumb.appendChild(entry.thumbnailCanvas.cloneNode(true));
          // Copy canvas content
          var srcCtx = entry.thumbnailCanvas.getContext('2d');
          var destCanvas = thumb.querySelector('canvas');
          destCanvas.width = entry.thumbnailCanvas.width;
          destCanvas.height = entry.thumbnailCanvas.height;
          destCanvas.getContext('2d').drawImage(entry.thumbnailCanvas, 0, 0);
        } else {
          thumb.classList.add('file-item__thumb--loading');
        }
        li.appendChild(thumb);

        // Info
        var info = document.createElement('div');
        info.className = 'file-item__info';

        var nameRow = document.createElement('div');
        nameRow.className = 'file-item__name-row';

        var nameSpan = document.createElement('span');
        nameSpan.className = 'file-item__name';
        nameSpan.textContent = entry.name;
        nameSpan.title = entry.name;
        nameRow.appendChild(nameSpan);

        var badge = document.createElement('span');
        var extLabel = getFileExtLabel(entry);
        badge.className = 'file-item__badge ' + (entry.type === 'pdf' ? 'file-item__badge--pdf' : 'file-item__badge--image');
        badge.textContent = extLabel;
        nameRow.appendChild(badge);

        info.appendChild(nameRow);

        if (entry.error) {
          var errMsg = document.createElement('span');
          errMsg.className = 'file-item__error-msg';
          errMsg.textContent = entry.error;
          info.appendChild(errMsg);
        } else {
          var meta = document.createElement('span');
          meta.className = 'file-item__meta';
          meta.id = 'meta-' + entry.id;
          if (entry.type === 'pdf') {
            if (entry.pageCount > 0) {
              meta.textContent = entry.pageCount + (entry.pageCount === 1 ? ' page' : ' pages') + ' \u2014 ' + formatFileSize(entry.size);
            } else {
              meta.textContent = formatFileSize(entry.size);
            }
          } else {
            meta.textContent = formatFileSize(entry.size);
          }
          info.appendChild(meta);
        }

        li.appendChild(info);

        // Remove button
        var removeBtn = document.createElement('button');
        removeBtn.className = 'file-item__remove';
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', 'Remove ' + escapeAttr(entry.name));
        removeBtn.innerHTML = '<svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="2" y1="2" x2="12" y2="12"/><line x1="12" y1="2" x2="2" y2="12"/></svg>';
        removeBtn.addEventListener('click', function () {
          removeFile(entry.id);
        });
        li.appendChild(removeBtn);

        return li;
      }

      function updateFileItem(entry) {
        var li = fileListEl.querySelector('[data-id="' + entry.id + '"]');
        if (!li) return;

        // Update error state
        if (entry.error) {
          li.classList.add('file-item--error');
        }

        // Update thumbnail
        var thumb = li.querySelector('.file-item__thumb');
        if (thumb) {
          thumb.classList.remove('file-item__thumb--loading');
          if (entry.error) {
            thumb.innerHTML = '<span class="file-item__thumb-error" aria-hidden="true">!</span>';
          } else if (entry.thumbnailCanvas) {
            thumb.innerHTML = '';
            var canvas = document.createElement('canvas');
            canvas.width = entry.thumbnailCanvas.width;
            canvas.height = entry.thumbnailCanvas.height;
            canvas.getContext('2d').drawImage(entry.thumbnailCanvas, 0, 0);
            canvas.style.opacity = '0';
            canvas.style.transition = 'opacity 0.2s ease';
            thumb.appendChild(canvas);
            // Fade in
            requestAnimationFrame(function () {
              canvas.style.opacity = '1';
            });
          }
        }

        // Update meta
        var meta = document.getElementById('meta-' + entry.id);
        if (meta && !entry.error) {
          if (entry.type === 'pdf' && entry.pageCount > 0) {
            meta.textContent = entry.pageCount + (entry.pageCount === 1 ? ' page' : ' pages') + ' \u2014 ' + formatFileSize(entry.size);
          }
        }

        // Update error message
        if (entry.error) {
          var infoEl = li.querySelector('.file-item__info');
          var existingErr = infoEl.querySelector('.file-item__error-msg');
          var existingMeta = infoEl.querySelector('.file-item__meta');
          if (existingMeta) existingMeta.remove();
          if (!existingErr) {
            var errMsg = document.createElement('span');
            errMsg.className = 'file-item__error-msg';
            errMsg.textContent = entry.error;
            infoEl.appendChild(errMsg);
          }
        }
      }

      function updatePageCount() {
        var totalPages = 0;
        var validFiles = 0;
        files.forEach(function (f) {
          if (!f.error) {
            totalPages += f.pageCount;
            validFiles++;
          }
        });

        pageSummary.textContent = 'Total: ' + totalPages + (totalPages === 1 ? ' page' : ' pages') + ' from ' + validFiles + (validFiles === 1 ? ' file' : ' files');

        if (validFiles > 0 && !isCombining) {
          combineBtn.disabled = false;
          combineBtn.innerHTML = 'Combine &amp; Download (' + totalPages + (totalPages === 1 ? ' page' : ' pages') + ')';
        } else if (!isCombining) {
          combineBtn.disabled = true;
          combineBtn.innerHTML = 'Combine &amp; Download';
        }
      }

      function removeFile(id) {
        var idx = files.findIndex(function (f) { return f.id === id; });
        if (idx === -1) return;
        files.splice(idx, 1);

        if (files.length === 0) {
          renderAll();
          uploadZone.focus();
          return;
        }

        // Remove from DOM
        var li = fileListEl.querySelector('[data-id="' + id + '"]');
        var nextLi = li ? li.nextElementSibling : null;
        var prevLi = li ? li.previousElementSibling : null;
        if (li) li.remove();

        updatePageCount();

        // Focus next item, then previous, then add-more button
        var targetLi = nextLi || prevLi;
        if (targetLi) {
          var btn = targetLi.querySelector('.file-item__remove');
          if (btn) btn.focus();
          else addMoreBtn.focus();
        } else {
          addMoreBtn.focus();
        }
      }

      // --- SortableJS ---

      function initSortable() {
        destroySortable();
        sortable = new Sortable(fileListEl, {
          animation: 150,
          ghostClass: 'file-item--ghost',
          chosenClass: 'file-item--chosen',
          handle: '.file-item__handle',
          onEnd: function (evt) {
            var movedItem = files.splice(evt.oldIndex, 1)[0];
            files.splice(evt.newIndex, 0, movedItem);
          }
        });
      }

      function destroySortable() {
        if (sortable) {
          sortable.destroy();
          sortable = null;
        }
      }

      // --- Combine & Download ---

      async function combineAndDownload() {
        isCombining = true;
        var validFiles = files.filter(function (f) { return !f.error && f.pageCount > 0; });
        if (validFiles.length === 0) {
          isCombining = false;
          return;
        }

        // Update UI to combining state
        combineBtn.disabled = true;
        combineBtn.innerHTML = '<span class="combine-btn__spinner"></span> Combining ' + validFiles.length + (validFiles.length === 1 ? ' file' : ' files') + '\u2026';
        fileListEl.classList.add('file-list--combining');
        addMoreBtn.disabled = true;
        clearAllBtn.disabled = true;

        try {
          var pdfDoc = await PDFLib.PDFDocument.create();

          for (var i = 0; i < files.length; i++) {
            var entry = files[i];
            if (entry.error || entry.pageCount === 0) continue;

            if (entry.type === 'pdf') {
              await addPdfPages(pdfDoc, entry);
            } else {
              await addImagePage(pdfDoc, entry);
            }

            // Yield to browser between files
            await new Promise(function (r) { setTimeout(r, 0); });
          }

          var pdfBytes = await pdfDoc.save();
          var filename = 'combined-' + validFiles.length + '-files.pdf';
          triggerDownload(pdfBytes, filename, 'application/pdf');

          // Success flash
          combineBtn.classList.add('combine-btn--success');
          combineBtn.innerHTML = '\u2713 Downloaded!';

          setTimeout(function () {
            combineBtn.classList.remove('combine-btn--success');
            isCombining = false;
            updatePageCount();
            fileListEl.classList.remove('file-list--combining');
            addMoreBtn.disabled = false;
            clearAllBtn.disabled = false;
          }, 2000);

        } catch (err) {
          showToast('Something went wrong combining your files. Please try again.');
          isCombining = false;
          updatePageCount();
          fileListEl.classList.remove('file-list--combining');
          addMoreBtn.disabled = false;
          clearAllBtn.disabled = false;
        }
      }

      async function addPdfPages(outputDoc, entry) {
        if (!entry.pdfLibDoc) {
          // Reload from file if needed
          var arrayBuffer = await readFileAsArrayBuffer(entry.file);
          entry.pdfLibDoc = await PDFLib.PDFDocument.load(new Uint8Array(arrayBuffer), { ignoreEncryption: true });
        }
        var pageIndices = [];
        for (var i = 0; i < entry.pdfLibDoc.getPageCount(); i++) {
          pageIndices.push(i);
        }
        var copiedPages = await outputDoc.copyPages(entry.pdfLibDoc, pageIndices);
        copiedPages.forEach(function (page) {
          outputDoc.addPage(page);
        });
      }

      async function addImagePage(outputDoc, entry) {
        var arrayBuffer = await readFileAsArrayBuffer(entry.file);
        var bytes = new Uint8Array(arrayBuffer);
        var embeddedImage;

        if (entry.file.type === 'image/png') {
          embeddedImage = await outputDoc.embedPng(bytes);
        } else if (entry.file.type === 'image/jpeg') {
          embeddedImage = await outputDoc.embedJpg(bytes);
        } else {
          // Convert to PNG via canvas
          var img = await loadImage(entry.file);
          var canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          var ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          var dataUrl = canvas.toDataURL('image/png');
          var base64 = dataUrl.split(',')[1];
          var pngBytes = Uint8Array.from(atob(base64), function (c) { return c.charCodeAt(0); });
          embeddedImage = await outputDoc.embedPng(pngBytes);
        }

        var page = outputDoc.addPage([embeddedImage.width, embeddedImage.height]);
        page.drawImage(embeddedImage, {
          x: 0,
          y: 0,
          width: embeddedImage.width,
          height: embeddedImage.height
        });
      }

      // --- Toast ---

      function showToast(message) {
        if (toastTimer) {
          clearTimeout(toastTimer);
          toastTimer = null;
        }
        toastText.textContent = message;
        toastEl.classList.add('toast--visible');
        toastTimer = setTimeout(function () {
          toastEl.classList.remove('toast--visible');
          toastTimer = null;
        }, 4000);
      }

      // --- Helpers ---

      function triggerDownload(data, filename, mimeType) {
        var blob = data instanceof Blob ? data : new Blob([data], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      function escapeAttr(str) {
        return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }
    })();
  </script>
</body>
</html>
